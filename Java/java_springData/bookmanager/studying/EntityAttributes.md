# Entity Attributes(annotation)

 ### 1. `@Entity`

- 해당 객체가 jpa에서 관리하고 있는 entity임을 정의
- 내부에 PK가 반드시 존재해야 함
  
### 2. `@Id`

- 해당 변수를 pk로 선언

### 3. GeneratedValue

```java
@Target({METHOD, FIELD})
@Retention(RUNTIME)

public @interface GeneratedValue {

    /**
     * (Optional) The primary key generation strategy
     * that the persistence provider must use to
     * generate the annotated entity primary key.
     */
    GenerationType strategy() default AUTO;

    /**
     * (Optional) The name of the primary key generator
     * to use as specified in the {@link SequenceGenerator} 
     * or {@link TableGenerator} annotation.
     * <p> Defaults to the id generator supplied by persistence provider.
     */
    String generator() default "";
}


```
- `GenerationType`
  - 4가지 값을 제공함

    1. `IDENTITY` : MYSQL Db에서 많이 사용하는 전략

        - 가장 흔하게 쓰이는 설정값
        - AutoIncerement
  
    2. `SEQUENCE`

        - sequence()라는 함수를 제공하는 ORICLE 등에서 사용
        - H2 db도 sequence 전략 사용
        - insert될 때 hibernate_sequence에서 증가된 값을 받아 id를 채움

    3. `TABLE`

        - db에 상관없이 id값을 관리하는 별도의 Table을 만들어두고 테이블에서 id값을 계속 추출해서 사용할 수 있도록 제공

    4. `AUTO`

        - 별도의 선언이 없을 때 적용
        - 각 db에 적합한 값을 자동으로 제공
        - 하지만 일반적으로 고정해서 사용해야하기 떄문에 선언해주는 것이 맞음

    ```java
    /*
     * Copyright (c) 2008, 2019 Oracle and/or its affiliates. All rights reserved.
     *
     * This program and the accompanying materials are made available under the
     * terms of the Eclipse Public License v. 2.0 which is available at
     * http://www.eclipse.org/legal/epl-2.0,
     * or the Eclipse Distribution License v. 1.0 which is available at
     * http://www.eclipse.org/org/documents/edl-v10.php.
     *
     * SPDX-License-Identifier: EPL-2.0 OR BSD-3-Clause
     */

    // Contributors:
    //     Linda DeMichiel - 2.1
    //     Linda DeMichiel - 2.0

    package javax.persistence;

    /** 
     * Defines the types of primary key generation strategies. 
     *
     * @see GeneratedValue
     *
     * @since 1.0
     */
    public enum GenerationType { 

        /**
         * Indicates that the persistence provider must assign 
         * primary keys for the entity using an underlying 
         * database table to ensure uniqueness.
         */
        TABLE, 

        /**
         * Indicates that the persistence provider must assign 
         * primary keys for the entity using a database sequence.
         */
        SEQUENCE, 

        /**
         * Indicates that the persistence provider must assign 
         * primary keys for the entity using a database identity column.
         */
        IDENTITY, 

        /**
         * Indicates that the persistence provider should pick an 
         * appropriate strategy for the particular database. The 
         * <code>AUTO</code> generation strategy may expect a database 
         * resource to exist, or it may attempt to create one. A vendor 
         * may provide documentation on how to create such resources 
         * in the event that it does not support schema generation 
         * or cannot create the schema resource at runtime.
         */
        AUTO
    }

    ```

### 4. `@Table`

- table의 name, catalog, schema, uniqueConstraints, indexes 옵션 제공
- `uniqueConstraints`
  
    - 복합키를 만들 때 주로 사용
    - 그 외에 컬럼 하나에 unique 제약 조건을 주고 싶을 땐 `@Column`에서 unique조건 설정

- `indexes`

    - 선언 컬럼에 인덱스 생성
- 이런 조건은 db에 맡기고 보통은 Entity 옵션에서 설정하지 않음
  

```java
package com.jpa.fedeleo.bookmanager.domain;

...
@Table(indexes = {@Index(columnList = "name")}, uniqueConstraints = {@UniqueConstraint(columnNames = {"email"})})
public class UserTable {

    @Id // pk
    @GeneratedValue // autoincrement,
    private Long id;
    @NonNull
    private String name;
    @NonNull
    private String email;
    ...
}


```

### 5. `@Column`

- db의 필드에 대한 속성들을 제어

```java
@Target({METHOD, FIELD}) 
@Retention(RUNTIME)
public @interface Column {

    /**
     * (Optional) The name of the column. Defaults to 
     * the property or field name.
     */
    String name() default "";

    /**
     * (Optional) Whether the column is a unique key.  This is a 
     * shortcut for the <code>UniqueConstraint</code> annotation at the table 
     * level and is useful for when the unique key constraint 
     * corresponds to only a single column. This constraint applies 
     * in addition to any constraint entailed by primary key mapping and 
     * to constraints specified at the table level.
     */
    boolean unique() default false;

    /**
     * (Optional) Whether the database column is nullable.
     */
    boolean nullable() default true;

    /**
     * (Optional) Whether the column is included in SQL INSERT 
     * statements generated by the persistence provider.
     */
    boolean insertable() default true;

    /**
     * (Optional) Whether the column is included in SQL UPDATE 
     * statements generated by the persistence provider.
     */
    boolean updatable() default true;

    /**
     * (Optional) The SQL fragment that is used when 
     * generating the DDL for the column.
     * <p> Defaults to the generated SQL to create a
     * column of the inferred type.
     */
    String columnDefinition() default "";

    /**
     * (Optional) The name of the table that contains the column. 
     * If absent the column is assumed to be in the primary table.
     */
    String table() default "";

    /**
     * (Optional) The column length. (Applies only if a
     * string-valued column is used.)
     */
    int length() default 255;

    /**
     * (Optional) The precision for a decimal (exact numeric) 
     * column. (Applies only if a decimal column is used.)
     * Value must be set by developer if used when generating 
     * the DDL for the column.
     */
    int precision() default 0;

    /**
     * (Optional) The scale for a decimal (exact numeric) column. 
     * (Applies only if a decimal column is used.)
     */
    int scale() default 0;
}

```

- `name` : 대개 DB는 그대로 유지하되, 어플리케이션을 리빌딩하려할 때 사용
- `nullable` : null 제약조건을 지정
- `unique` : unique 제약조건을 지정
- `length` : varchar 길이의 조절(default = 255)
- `insertable`

    - DML에 영향을 줌
    - false : 생성(insert) 시에 값이 입력이 안되고 수정(update) 시에 값이 삽입됨
  
- `upatable`

    - false : 생성(insert) 시에 값이 입력되고 수정(update) 시에 값 변경이 되지 않음

```java
package com.jpa.fedeleo.bookmanager.domain;

@Data
@Entity // 객체를 entity로 선언. 내부에 primaery key 선언이 필수
@Builder
@NoArgsConstructor
@AllArgsConstructor
@RequiredArgsConstructor
@Table(indexes = {@Index(columnList = "name")}, uniqueConstraints = {@UniqueConstraint(columnNames = {"email"})})
public class UserTable {
    
    ...

    @Column(updatable = false)
    private LocalDateTime createdAt;

    @Column(insertable = false)
    private LocalDateTime updatedAt;

}

```
```sql

    insert 
    into
        user_table
        (created_at, email, name, id) 
    values
        (?, ?, ?, ?)

    -- ----------------------------------
    update
        user_table 
    set
        email=?,
        name=?,
        updated_at=? 
    where
        id=?

```

-  `@Transient`

   - entity가 db의 데이터와 별개의 데이터를 가지고 싶을 때 사용
   - 해당 객체와 생명 주기를 같이 함

- `@Enumerated`
    - java에서 상수를 사용할 때 Enum클래스를 생성하여 상수값을 반환한다.
    - 이 때 entity 객체에서 enum클래스를 이용하여 값을 db에 저장하면 enum클래스 내부 상수의 순서에 매칭되는 값으로 저장된다.
    - 이는 `@Entity`에서 enum클래스를 참조할 때 EnumType의 Default가 ORDINAL이기 때문임.
      - 이 enum 클래스의 값을 수정할 때 잠재적 버그의 원인이 될 수 있음
      - 이를 피하기 위해 EnumType을 String으로 설정하는 것이 중요하다.

```java

package com.jpa.fedeleo.bookmanager.domain;

public enum Gender {
    MALE,
    FEMALE
}
//--------------------------------------------
package com.jpa.fedeleo.bookmanager.domain;

@Data
@Entity // 객체를 entity로 선언. 내부에 primaery key 선언이 필수
@Builder
@NoArgsConstructor
@AllArgsConstructor
@RequiredArgsConstructor
@Table(indexes = {@Index(columnList = "name")}, uniqueConstraints = {@UniqueConstraint(columnNames = {"email"})})
public class UserTable {

    ...

    @Enumerated(value = EnumType.STRING)
    private Gender gender;

}
// ---------------------------------------------

package com.jpa.fedeleo.bookmanager.repository;

public interface UserTableRepository extends JpaRepository<UserTable, Long> {
    
    ...

    @Query(value="select * from user_table limit 1", nativeQuery = true)
    Map<String, Object> findRawRecord();
}


```

```java

package com.jpa.fedeleo.bookmanager.repository;

@SpringBootTest
class UserTableRepositoryTest {

    @Autowired
    private UserTableRepository userTableRepository;

    ...

    @Test
    void EnumTest(){
        UserTable user = userTableRepository.findById(1L).orElseThrow(RuntimeException::new);
        user.setGender(Gender.MALE);
        userTableRepository.save(user);

        userTableRepository.findAll().forEach(System.out::println);

        System.out.println(userTableRepository.findRawRecord().get("gender"));

        // MALE

    }
}

```

