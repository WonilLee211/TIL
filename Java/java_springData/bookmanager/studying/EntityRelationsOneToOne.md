# Entity Relations 

- JPA는 속성에 따라서 최적의 Query를 자동으로 생성하기 때문에 어떤 속성에 따라서 Query가 생성되는지 명확히 알아야 함
- **table과 entity를 열심히 설계해서 원하는 쿼리가 나오도록 하는 것이 jpa 고수로 가는 길**


## 1. `@OneToOne`

### BookReviewInfo에서 Book정보 참조하기

```java

package com.jpa.fedeleo.bookmanager.domain;

@Data
@MappedSuperclass
@EntityListeners(value = AuditingEntityListener.class)
public class BaseEntity implements Auditable {
    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;

}
```

```java
package com.jpa.fedeleo.bookmanager.domain;

@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
@Data
@NoArgsConstructor
public class Book extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String category;

    private Long authorId;

    private Long publisherId;
}

```

- `@OneToOne` : db에 저장할 땐 참조 객체의 pk를 가져와서 저장함

```java
package com.jpa.fedeleo.bookmanager.domain;

@Entity
@NoArgsConstructor
@Data
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class BookReviewInfo extends BaseEntity{
    @Id
    @GeneratedValue
    private Long id;

//    private Long bookId;

    @OneToOne
    private Book book;

    private float averageReviewScore;

    private int reviewCount;

}
```

- test : Book 객체를 생성 후 BookReviewInfo로 저장 

```java
    private Book givenBook(){
        Book book = new Book();
        book.setName("jpa 1:1 entity relations");
        book.setAuthorId(1L);
        book.setPublisherId(1L);

        return bookRepository.save(book);
    }

    private void bookReviewInfo(){
        BookReviewInfo bookReviewInfo = new BookReviewInfo();
        bookReviewInfo.setBook(givenBook());
        bookReviewInfo.setAverageReviewScore(4.5F);
        bookReviewInfo.setReviewCount(2);

        bookReviewInfoRepository.save(bookReviewInfo);

        System.out.println(">>>" + bookReviewInfoRepository.findAll());
    }

```

- DDL sql
  - book_review_info테이블에서 OneToOne relation으로 참조한 book 객체를 book_id로 저장됨

```sql
create table book (
    id bigint generated by default as identity,
    created_at timestamp,
    updated_at timestamp,
    author_id bigint,
    category varchar(255),
    name varchar(255),
    publisher_id bigint,
    primary key (id)
)

Hibernate: 

create table book_review_info (
    id bigint not null,
    created_at timestamp,
    updated_at timestamp,
    average_review_score float not null,
    review_count integer not null,
    book_id bigint,
    primary key (id)
)

```

- BookReviewInfo 조회할 때 book객체가 left Outer join
  
```sql
Hibernate: 
    insert 
    into
        book
        (id, created_at, updated_at, author_id, category, name, publisher_id) 
    values
        (default, ?, ?, ?, ?, ?, ?)
Hibernate: 
    call next value for hibernate_sequence
Hibernate: 
    insert 
    into
        book_review_info
        (created_at, updated_at, average_review_score, book_id, review_count, id) 
    values
        (?, ?, ?, ?, ?, ?)
Hibernate: 
    select
        bookreview0_.id as id1_2_,
        bookreview0_.created_at as created_2_2_,
        bookreview0_.updated_at as updated_3_2_,
        bookreview0_.average_review_score as average_4_2_,
        bookreview0_.book_id as book_id6_2_,
        bookreview0_.review_count as review_c5_2_ 
    from
        book_review_info bookreview0_
Hibernate: 
    select
        book0_.id as id1_1_0_,
        book0_.created_at as created_2_1_0_,
        book0_.updated_at as updated_3_1_0_,
        book0_.author_id as author_i4_1_0_,
        book0_.category as category5_1_0_,
        book0_.name as name6_1_0_,
        book0_.publisher_id as publishe7_1_0_ 
    from
        book book0_ 
    where
        book0_.id=?
>>>[BookReviewInfo(super=BaseEntity(createdAt=2022-12-24T22:41:35.230815, updatedAt=2022-12-24T22:41:35.230815), id=1, book=Book(super=BaseEntity(createdAt=2022-12-24T22:41:35.137066, updatedAt=2022-12-24T22:41:35.137066), id=1, name=jpa 1:1 entity relations, category=null, authorId=1, publisherId=1), averageReviewScore=4.5, reviewCount=2)]
Hibernate: 
    select
        bookreview0_.id as id1_2_0_,
        bookreview0_.created_at as created_2_2_0_,
        bookreview0_.updated_at as updated_3_2_0_,
        bookreview0_.average_review_score as average_4_2_0_,
        bookreview0_.book_id as book_id6_2_0_,
        bookreview0_.review_count as review_c5_2_0_,
        book1_.id as id1_1_1_,
        book1_.created_at as created_2_1_1_,
        book1_.updated_at as updated_3_1_1_,
        book1_.author_id as author_i4_1_1_,
        book1_.category as category5_1_1_,
        book1_.name as name6_1_1_,
        book1_.publisher_id as publishe7_1_1_ 
    from
        book_review_info bookreview0_ 
    left outer join
        book book1_ 
            on bookreview0_.book_id=book1_.id 
    where
        bookreview0_.id=?
>>>Book(super=BaseEntity(createdAt=2022-12-24T22:41:35.137066, updatedAt=2022-12-24T22:41:35.137066), id=1, name=jpa 1:1 entity relations, category=null, authorId=1, publisherId=1)

```

  
### OneToOne 제공 옵션 1. optional

- optional = false
  - 해당 참조 관계에 null이 허용되지 않음
  - not null constraint 추가

```java

package com.jpa.fedeleo.bookmanager.domain;

@Entity
@NoArgsConstructor
@Data
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class BookReviewInfo extends BaseEntity{
    @Id
    @GeneratedValue
    private Long id;

//    private Long bookId;

    @OneToOne(optional = false)
    private Book book;

    private float averageReviewScore;

    private int reviewCount;

}

```

- join 조건이 inner join으로 변경됨
- 자바 객체의 조건에 따라 최적의 query문을 작성해주는 것이 jpa의 역할

```sql

...

Hibernate: 
    select
        book0_.id as id1_1_0_,
        book0_.created_at as created_2_1_0_,
        book0_.updated_at as updated_3_1_0_,
        book0_.author_id as author_i4_1_0_,
        book0_.category as category5_1_0_,
        book0_.name as name6_1_0_,
        book0_.publisher_id as publishe7_1_0_ 
    from
        book book0_ 
    where
        book0_.id=?
>>>[BookReviewInfo(super=BaseEntity(createdAt=2022-12-25T15:55:34.291777, updatedAt=2022-12-25T15:55:34.291777), id=1, book=Book(super=BaseEntity(createdAt=2022-12-25T15:55:34.176086, updatedAt=2022-12-25T15:55:34.176086), id=1, name=jpa 1:1 entity relations, category=null, authorId=1, publisherId=1), averageReviewScore=4.5, reviewCount=2)]

Hibernate: 
    select
        bookreview0_.id as id1_2_0_,
        bookreview0_.created_at as created_2_2_0_,
        bookreview0_.updated_at as updated_3_2_0_,
        bookreview0_.average_review_score as average_4_2_0_,
        bookreview0_.book_id as book_id6_2_0_,
        bookreview0_.review_count as review_c5_2_0_,
        book1_.id as id1_1_1_,
        book1_.created_at as created_2_1_1_,
        book1_.updated_at as updated_3_1_1_,
        book1_.author_id as author_i4_1_1_,
        book1_.category as category5_1_1_,
        book1_.name as name6_1_1_,
        book1_.publisher_id as publishe7_1_1_ 
    from
        book_review_info bookreview0_ 
    inner join
        book book1_ 
            on bookreview0_.book_id=book1_.id 
    where
        bookreview0_.id=?
>>>Book(super=BaseEntity(createdAt=2022-12-25T15:55:34.176086, updatedAt=2022-12-25T15:55:34.176086), id=1, name=jpa 1:1 entity relations, category=null, authorId=1, publisherId=1)

```

### Book에서 BookReviewInfo 정보 참조하기

- 참조 필드 추가

```java

package com.jpa.fedeleo.bookmanager.domain;

@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
@Data
@NoArgsConstructor
public class Book extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String category;

    private Long authorId;

    private Long publisherId;
    
    @OneToOne
    private BookReviewInfo bookReviewInfo; 
}

```

### OneToOne 제공 옵션 2. mappedBy

- 역참조할 때 사용
- 선언한 위치의 필드는 db에서 사라짐
- 따라서, 기본 참조 필드를 가지는 객체가 아닌 역참조하는 relation 내에 필드를 추가하고 mappedBy옵션을 설정하기
    - entity를 참조하는 경우 toString()같은 메서드가 순환 오버플로우 발생함
    - 그래서 단방향으로 걸거나, toString에서 제외시켜야 함

```java
package com.jpa.fedeleo.bookmanager.domain;

@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
@Data
@NoArgsConstructor
public class Book extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String category;

    private Long authorId;

    private Long publisherId;

    @OneToOne(mappedBy = "book")
    @ToString.Exclude
    private BookReviewInfo bookReviewInfo;
}


```

- book relation에서는 bookReviewInfo_id가 사라짐
- book_review_info relation에서는 book_id가 유지됨

```sql
Hibernate: 
    
    create table book (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        author_id bigint,
        category varchar(255),
        name varchar(255),
        publisher_id bigint,
        primary key (id)
    )
Hibernate: 
    
    create table book_review_info (
       id bigint not null,
        created_at timestamp,
        updated_at timestamp,
        average_review_score float not null,
        review_count integer not null,
        book_id bigint not null,
        primary key (id)
    )
```

- bookRepository에서 BookReViewInfo조회하기
```java
  @Test
    void crudTest2(){

        ...

        BookReviewInfo result1 = bookRepository
                .findById(1L)
                .orElseThrow(RuntimeException::new)
                .getBookReviewInfo();

        System.out.println(">>>" + result1);

    }

```
```sql
...

Hibernate:  
    select
        book0_.id as id1_1_0_,
        book0_.created_at as created_2_1_0_,
        book0_.updated_at as updated_3_1_0_,
        book0_.author_id as author_i4_1_0_,
        book0_.category as category5_1_0_,
        book0_.name as name6_1_0_,
        book0_.publisher_id as publishe7_1_0_,
        bookreview1_.id as id1_2_1_,
        bookreview1_.created_at as created_2_2_1_,
        bookreview1_.updated_at as updated_3_2_1_,
        bookreview1_.average_review_score as average_4_2_1_,
        bookreview1_.book_id as book_id6_2_1_,
        bookreview1_.review_count as review_c5_2_1_ 
    from
        book book0_ 
    left outer join
        book_review_info bookreview1_ 
            on book0_.id=bookreview1_.book_id 
    where
        book0_.id=?

>>>BookReviewInfo(super=BaseEntity(createdAt=2022-12-25T16:54:32.569599, updatedAt=2022-12-25T16:54:32.569599), id=1, book=Book(super=BaseEntity(createdAt=2022-12-25T16:54:32.483829, updatedAt=2022-12-25T16:54:32.483829), id=1, name=jpa 1:1 entity relations, category=null, authorId=1, publisherId=1), averageReviewScore=4.5, reviewCount=2)


```
