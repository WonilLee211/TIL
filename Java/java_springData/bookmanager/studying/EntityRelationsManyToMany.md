# Entity Relations 

- JPA는 속성에 따라서 최적의 Query를 자동으로 생성하기 때문에 어떤 속성에 따라서 Query가 생성되는지 명확히 알아야 함
- **table과 entity를 열심히 설계해서 원하는 쿼리가 나오도록 하는 것이 jpa 고수로 가는 길**


## 3. M:N relation

### `@ManyToMany`

- 다수의 엔티티를 입력하는 메서드 작성

```java
package com.jpa.fedeleo.bookmanager.domain;

@Entity
@NoArgsConstructor
@Data
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class Author extends BaseEntity{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String country;

    @ManyToMany
    @ToString.Exclude
    private List<Book> books = new ArrayList<>();

    public void addBooks(Book... books){
        Collections.addAll(this.books, books);
    };


}

// _----------------------------------------
package com.jpa.fedeleo.bookmanager.domain;

@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
@Data
@NoArgsConstructor
public class Book extends BaseEntity {

    ...

    @ManyToMany
    @ToString.Exclude
    private List<Author> authors = new ArrayList<>();

    public void addAuthors(Author... authors){
        Collections.addAll(this.authors, authors);
    }

}

```

- 각각의 중계테이블이 생긴다.

```sql
    create table author (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        country varchar(255),
        name varchar(255),
        primary key (id)
    )
Hibernate: 
    
    create table author_books (
       author_id bigint not null,
        books_id bigint not null
    )
Hibernate: 
    
    create table book (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        author_id bigint,
        category varchar(255),
        name varchar(255),
        publisher_id bigint,
        primary key (id)
    )
Hibernate:
    
    create table book_authors (
       book_id bigint not null,
        authors_id bigint not null
    )
```

- test code

```sql

Hibernate: 
    select
        book0_.id as id1_3_,
        book0_.created_at as created_2_3_,
        book0_.updated_at as updated_3_3_,
        book0_.author_id as author_i4_3_,
        book0_.category as category5_3_,
        book0_.name as name6_3_,
        book0_.publisher_id as publishe7_3_ 
    from
        book book0_

authors through book : [Author(super=BaseEntity(createdAt=2022-12-26T13:40:35.785899900, updatedAt=2022-12-26T13:40:35.785899900), id=1, name=martin, country=null), Author(super=BaseEntity(createdAt=2022-12-26T13:40:35.802856200, updatedAt=2022-12-26T13:40:35.802856200), id=2, name=steve, country=null)]

Hibernate: 
    select
        author0_.id as id1_1_,
        author0_.created_at as created_2_1_,
        author0_.updated_at as updated_3_1_,
        author0_.country as country4_1_,
        author0_.name as name5_1_ 
    from
        author author0_

books through author : [Book(super=BaseEntity(createdAt=2022-12-26T13:40:35.534579100, updatedAt=2022-12-26T13:40:35.534579100), id=1, name=책1, category=null, authorId=null), Book(super=BaseEntity(createdAt=2022-12-26T13:40:35.760982800, updatedAt=2022-12-26T13:40:35.760982800), id=3, name=개발책1, category=null, authorId=null), Book(super=BaseEntity(createdAt=2022-12-26T13:40:35.765952, updatedAt=2022-12-26T13:40:35.765952), id=4, name=개발책2, category=null, authorId=null)]

```

### 중계 테이블을 이용한 M:N relation

- BookAndAuthor 테이블 생성
- `@OneToMany`로 필드를 BookAndAuthor 참조

```java
package com.jpa.fedeleo.bookmanager.domain;

@Entity
@Data
@NoArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class BookAndAuthor extends BaseEntity{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    private Book book;

    @ManyToOne
    private Author author;

}

```

- Author, Book 클래스 수정

```java

package com.jpa.fedeleo.bookmanager.domain;

@Entity
@NoArgsConstructor
@Data
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class Author extends BaseEntity{
    ...

//    @ManyToMany
    @OneToMany
    @JoinColumn(name = "author_id")
    @ToString.Exclude
    private List<BookAndAuthor> bookAndAuthors = new ArrayList<>();

    public void addBookAndAuthors(BookAndAuthor... bookAndAuthors){
        Collections.addAll(this.bookAndAuthors, bookAndAuthors);
    };
}

// --------------------------------------------

package com.jpa.fedeleo.bookmanager.domain;

@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
@Entity
@Data
@NoArgsConstructor
public class Book extends BaseEntity {
    ...

//    @ManyToMany
    @OneToMany
    @JoinColumn(name = "book_id")
    @ToString.Exclude
    private List<BookAndAuthor> bookAndAuthors = new ArrayList<>();

    public void addBookAndAuthors(BookAndAuthor... bookAndAuthors){
        Collections.addAll(this.bookAndAuthors, bookAndAuthors);
    };
}

```
- DDL
    - 중계 테이블이 하나로 준 것을 볼 수 있음
    - 각 엔티티의 @OneToMany 필드는 없고 중계 테이블에서 각각의 id가 생성된 것을 볼 수 있음

```sql
  
    create table author (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        country varchar(255),
        name varchar(255),
        primary key (id)
    )
----------------------------------------------    
    create table book (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        category varchar(255),
        name varchar(255),
        publisher_id bigint,
        primary key (id)
    )
----------------------------------------------    
    
    create table book_and_author (
       id bigint generated by default as identity,
        created_at timestamp,
        updated_at timestamp,
        author_id bigint,
        book_id bigint,
        primary key (id)
    )

```

- test code

```java
    @Test
    @Transactional
    void manyToManyTest(){

        // 객체 생성
        Book book1 = givenBook("책1");
        Book book2 = givenBook("책2");
        Book book3 = givenBook("개발책1");
        Book book4 = givenBook("개발책2");

        Author author1 = givenAuthor("martin");
        Author author2 = givenAuthor("steve");

        // 중계테이블에 저장

        BookAndAuthor bookAndAuthor1 = givenBookAndAuthor(book1, author1);
        BookAndAuthor bookAndAuthor2 = givenBookAndAuthor(book2, author2);
        BookAndAuthor bookAndAuthor3 = givenBookAndAuthor(book3, author1);
        BookAndAuthor bookAndAuthor4 = givenBookAndAuthor(book3, author2);
        BookAndAuthor bookAndAuthor5 = givenBookAndAuthor(book4, author1);
        BookAndAuthor bookAndAuthor6 = givenBookAndAuthor(book4, author2);

        // 각 객체에 정보 담기

        book1.addBookAndAuthors(bookAndAuthor1);
        book2.addBookAndAuthors(bookAndAuthor2);
        book3.addBookAndAuthors(bookAndAuthor3, bookAndAuthor5);
        book4.addBookAndAuthors(bookAndAuthor4, bookAndAuthor6);

        author1.addBookAndAuthors(bookAndAuthor1, bookAndAuthor3, bookAndAuthor5);
        author2.addBookAndAuthors(bookAndAuthor2, bookAndAuthor4, bookAndAuthor6 );

        // 각 엔터티에 객체 저장

        bookRepository.saveAll(Lists.newArrayList(book1, book2, book3, book4));
        authorRepository.saveAll(Lists.newArrayList(author1, author2));

        bookRepository.findAll().get(2).getBookAndAuthors().forEach(o ->System.out.println(o.getAuthor()));
        authorRepository.findAll().get(0).getBookAndAuthors().forEach(o-> System.out.println(o.getBook()));
    }


    private BookAndAuthor givenBookAndAuthor(Book book, Author author){

        BookAndAuthor bookAndAuthor = new BookAndAuthor();
        bookAndAuthor.setBook(book);
        bookAndAuthor.setAuthor(author);

        return bookAndAuthorRepository.save(bookAndAuthor);

    }

    private Book givenBook(String name){
        Book book =new Book();
        book.setName(name);
        return bookRepository.save(book);

    }

    private Author givenAuthor(String name){
        Author author = new Author();
        author.setName(name);
        return authorRepository.save(author);
    }

```

- 조회 결과

```sql

Hibernate: 
    select
        book0_.id as id1_2_,
        book0_.created_at as created_2_2_,
        book0_.updated_at as updated_3_2_,
        book0_.category as category4_2_,
        book0_.name as name5_2_,
        book0_.publisher_id as publishe6_2_ 
    from
        book book0_


Author(super=BaseEntity(createdAt=2022-12-26T17:23:42.149928700, updatedAt=2022-12-26T17:23:42.149928700), id=1, name=martin, country=null)
Author(super=BaseEntity(createdAt=2022-12-26T17:23:42.149928700, updatedAt=2022-12-26T17:23:42.149928700), id=1, name=martin, country=null)


Hibernate: 
    select
        author0_.id as id1_1_,
        author0_.created_at as created_2_1_,
        author0_.updated_at as updated_3_1_,
        author0_.country as country4_1_,
        author0_.name as name5_1_ 
    from
        author author0_

Book(super=BaseEntity(createdAt=2022-12-26T17:23:41.985373300, updatedAt=2022-12-26T17:23:41.985373300), id=1, name=책1, category=null)
Book(super=BaseEntity(createdAt=2022-12-26T17:23:42.135967600, updatedAt=2022-12-26T17:23:42.135967600), id=3, name=개발책1, category=null)
Book(super=BaseEntity(createdAt=2022-12-26T17:23:42.139956500, updatedAt=2022-12-26T17:23:42.139956500), id=4, name=개발책2, category=null)

```
